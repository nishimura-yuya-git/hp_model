---
description: 
globs: 
alwaysApply: true
---
# ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆåŸå‰‡ï¼ˆæ‹¡å¼µæ€§ãƒ»ä¿å®ˆæ€§é‡è¦–ï¼‰

## å¿…é ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆãƒ«ãƒ¼ãƒ«

### 1. åŸºæœ¬ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```sql
-- âŒ çµ¶å¯¾ç¦æ­¢ï¼šç›´æ¥é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id UUID REFERENCES roles(id) -- NG: ç›´æ¥å‚ç…§
);

-- âœ… å¿…é ˆï¼šä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«çµŒç”±
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«å¿…é ˆè¨­è¨ˆ
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  assigned_by UUID REFERENCES users(id),
  expires_at TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT true,
  metadata JSONB DEFAULT '{}',
  UNIQUE(user_id, role_id)
);
```

### 2. å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¦å‰‡
```sql
-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
CREATE TABLE example_table (
  -- ä¸»ã‚­ãƒ¼ï¼ˆå¿…é ˆï¼‰
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ç›£æŸ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¿…é ˆï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  
  -- è«–ç†å‰Šé™¤ï¼ˆå¿…é ˆï¼‰
  deleted_at TIMESTAMPTZ,
  deleted_by UUID REFERENCES users(id),
  
  -- ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
  version INTEGER DEFAULT 1 NOT NULL,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
  metadata JSONB DEFAULT '{}',
  
  -- ãƒ“ã‚¸ãƒã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  name TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'archived')),
  
  -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  search_vector tsvector GENERATED ALWAYS AS (to_tsvector('japanese', coalesce(name, '') || ' ' || coalesce(description, ''))) STORED
);

-- å¿…é ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_example_table_created_at ON example_table(created_at);
CREATE INDEX idx_example_table_status ON example_table(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_example_table_search ON example_table USING GIN(search_vector);
CREATE INDEX idx_example_table_metadata ON example_table USING GIN(metadata);
```

### 3. é–¢é€£æ€§ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤šå¯¾å¤šã®æ‹¡å¼µå¯èƒ½è¨­è¨ˆï¼‰
```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨çµ„ç¹”ã®é–¢é€£ï¼ˆæ‹¡å¼µå¯èƒ½ï¼‰
CREATE TABLE user_organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- é–¢ä¿‚ã®è©³ç´°æƒ…å ±
  role_type TEXT NOT NULL DEFAULT 'member' CHECK (role_type IN ('owner', 'admin', 'member', 'viewer')),
  permissions JSONB DEFAULT '[]',
  
  -- æœŸé–“ç®¡ç†
  started_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  ended_at TIMESTAMPTZ,
  
  -- æ‰¿èªãƒ•ãƒ­ãƒ¼
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'suspended', 'terminated')),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMPTZ,
  
  -- ç›£æŸ»
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚«ã‚¹ã‚¿ãƒ å±æ€§ï¼‰
  metadata JSONB DEFAULT '{}',
  
  UNIQUE(user_id, organization_id, started_at)
);
```

### 4. è¨­å®šãƒ»ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼ˆæŸ”è»Ÿãªè¨­å®šç®¡ç†ï¼‰
CREATE TABLE system_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category TEXT NOT NULL, -- 'auth', 'billing', 'ui', 'feature_flags'
  key TEXT NOT NULL,
  value JSONB NOT NULL,
  data_type TEXT NOT NULL CHECK (data_type IN ('string', 'number', 'boolean', 'object', 'array')),
  
  -- ç’°å¢ƒåˆ¥è¨­å®š
  environment TEXT DEFAULT 'production' CHECK (environment IN ('development', 'staging', 'production')),
  
  -- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  is_sensitive BOOLEAN DEFAULT false,
  required_permission TEXT,
  
  -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  validation_schema JSONB,
  default_value JSONB,
  
  -- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),
  
  UNIQUE(category, key, environment)
);
```

## RLSï¼ˆRow Level Securityï¼‰å¿…é ˆå®Ÿè£…

### 1. åŸºæœ¬çš„ãªRLSãƒãƒªã‚·ãƒ¼
```sql
-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSæœ‰åŠ¹åŒ–å¿…é ˆ
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "users_own_data" ON users
  FOR ALL USING (auth.uid() = id);

-- çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "organization_members" ON user_organizations
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM user_organizations uo
      WHERE uo.user_id = auth.uid()
      AND uo.organization_id = user_organizations.organization_id
      AND uo.status = 'active'
      AND (uo.ended_at IS NULL OR uo.ended_at > NOW())
    )
  );

-- ç®¡ç†è€…æ¨©é™ã®ãƒãƒªã‚·ãƒ¼
CREATE POLICY "admin_access" ON users
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN roles r ON ur.role_id = r.id
      WHERE ur.user_id = auth.uid()
      AND r.name = 'admin'
      AND ur.is_active = true
      AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
    )
  );
```

### 2. å‹•çš„æ¨©é™ç®¡ç†
```sql
-- æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
CREATE OR REPLACE FUNCTION check_user_permission(
  p_user_id UUID,
  p_permission TEXT,
  p_resource_id UUID DEFAULT NULL
) RETURNS BOOLEAN AS $$
DECLARE
  has_permission BOOLEAN := false;
BEGIN
  -- ã‚°ãƒ­ãƒ¼ãƒãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
  SELECT EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    JOIN role_permissions rp ON r.id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.id
    WHERE ur.user_id = p_user_id
    AND p.name = p_permission
    AND ur.is_active = true
    AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
  ) INTO has_permission;
  
  -- ãƒªã‚½ãƒ¼ã‚¹å›ºæœ‰ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
  IF NOT has_permission AND p_resource_id IS NOT NULL THEN
    SELECT EXISTS (
      SELECT 1 FROM resource_permissions rp
      WHERE rp.user_id = p_user_id
      AND rp.resource_id = p_resource_id
      AND rp.permission = p_permission
      AND rp.is_active = true
      AND (rp.expires_at IS NULL OR rp.expires_at > NOW())
    ) INTO has_permission;
  END IF;
  
  RETURN has_permission;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## Supabaseè¨­å®šãƒ»æœ€é©åŒ–

### 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
```sql
-- è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼ï¼ˆupdated_atï¼‰
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ãƒˆãƒªã‚¬ãƒ¼é©ç”¨ä¾‹
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON users 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

### 2. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§åˆ¶ç´„
```sql
-- è¤‡åˆåˆ¶ç´„ã®ä¾‹
ALTER TABLE user_organizations 
ADD CONSTRAINT check_date_range 
CHECK (started_at <= COALESCE(ended_at, '2099-12-31'::timestamptz));

-- æ¡ä»¶ä»˜ããƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
CREATE UNIQUE INDEX idx_active_user_org 
ON user_organizations (user_id, organization_id) 
WHERE status = 'active' AND ended_at IS NULL;
```

### 3. å…¨æ–‡æ¤œç´¢æœ€é©åŒ–
```sql
-- æ—¥æœ¬èªå…¨æ–‡æ¤œç´¢è¨­å®š
CREATE INDEX idx_posts_search_ja 
ON posts USING GIN(to_tsvector('japanese', title || ' ' || content));

-- æ¤œç´¢é–¢æ•°
CREATE OR REPLACE FUNCTION search_posts(search_query TEXT)
RETURNS TABLE(
  id UUID,
  title TEXT,
  content TEXT,
  rank REAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    p.id,
    p.title,
    p.content,
    ts_rank(to_tsvector('japanese', p.title || ' ' || p.content), plainto_tsquery('japanese', search_query)) as rank
  FROM posts p
  WHERE to_tsvector('japanese', p.title || ' ' || p.content) @@ plainto_tsquery('japanese', search_query)
  ORDER BY rank DESC;
END;
$$ LANGUAGE plpgsql;
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‘½åè¦å‰‡
```
YYYYMMDDHHMMSS_descriptive_name.sql
ä¾‹: 20241201120000_add_user_organizations_table.sql
```

### 2. å®‰å…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```sql
-- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ
BEGIN;

-- æ–°ã—ã„ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆNULLè¨±å¯ï¼‰
ALTER TABLE users ADD COLUMN phone TEXT;

-- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
UPDATE users SET phone = metadata->>'phone' WHERE metadata->>'phone' IS NOT NULL;

-- åˆ¶ç´„è¿½åŠ ï¼ˆæ®µéšçš„ï¼‰
-- 1. NOT NULLåˆ¶ç´„ã¯å¾Œã§è¿½åŠ 
-- ALTER TABLE users ALTER COLUMN phone SET NOT NULL;

COMMIT;
```

### 3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
```sql
-- å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨SQLæº–å‚™
-- down_20241201120000_add_user_organizations_table.sql
BEGIN;
ALTER TABLE users DROP COLUMN IF EXISTS phone;
COMMIT;
```
