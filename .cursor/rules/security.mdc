---
description: 
globs: 
alwaysApply: true
---
# ğŸ”’ çµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆåŒ…æ‹¬ç‰ˆï¼‰

## ç’°å¢ƒå¤‰æ•°ç®¡ç†ï¼ˆå¿…é ˆï¼‰

### ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹
```typescript
// .env.local ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ... # å…¬é–‹ã‚­ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ï¼‰
SUPABASE_SERVICE_ROLE_KEY=eyJ... # ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨ï¼‰

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
VITE_APP_ENV=development
VITE_API_BASE_URL=https://api.yourapp.com
VITE_ENABLE_ANALYTICS=true

# å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_... # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨
SENDGRID_API_KEY=SG... # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨

# âŒ çµ¶å¯¾ç¦æ­¢ï¼šæœ¬ç•ªç’°å¢ƒã®ç§˜åŒ¿æƒ…å ±ã‚’ã‚³ãƒŸãƒƒãƒˆ
# âŒ çµ¶å¯¾ç¦æ­¢ï¼šAPIã‚­ãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
```

### ç’°å¢ƒå¤‰æ•°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
// src/config/env.ts
const requiredEnvVars = [
  'VITE_SUPABASE_URL',
  'VITE_SUPABASE_ANON_KEY',
] as const;

const validateEnv = () => {
  const missing = requiredEnvVars.filter(
    (envVar) => !import.meta.env[envVar]
  );
  
  if (missing.length > 0) {
    throw new Error(
      `å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“: ${missing.join(', ')}`
    );
  }
};

validateEnv();
```

## Supabaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';
import type { Database } from '@/types/database.types';

// ç’°å¢ƒå¤‰æ•°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…é ˆï¼‰
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    'Supabaseç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚VITE_SUPABASE_URLã¨VITE_SUPABASE_ANON_KEYã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
  );
}

// URLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
if (!supabaseUrl.startsWith('https://') || !supabaseUrl.includes('.supabase.co')) {
  throw new Error('ä¸æ­£ãªSupabase URLã§ã™');
}

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
    flowType: 'pkce', // PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    debug: import.meta.env.DEV,
  },
  global: {
    headers: {
      'x-application-name': 'luxury-brand-app',
      'x-application-version': import.meta.env.VITE_APP_VERSION || '1.0.0',
    },
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
  db: {
    schema: 'public',
  },
});

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–
supabase.auth.onAuthStateChange((event, session) => {
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡ï¼‰
  if (import.meta.env.PROD) {
    console.info('Auth event:', { event, userId: session?.user?.id });
  }
  
  // ç•°å¸¸ãªãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®æ¤œå‡º
  if (event === 'SIGNED_OUT' && !session) {
    // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®å¯èƒ½æ€§
    console.warn('Unexpected sign out detected');
  }
});
```

## å…¥åŠ›å€¤æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåŒ…æ‹¬ç‰ˆï¼‰

```typescript
// src/utils/validation.ts
import { z } from 'zod';
import DOMPurify from 'dompurify';

// å…±é€šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«
const commonRules = {
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå›½éš›åŒ–å¯¾å¿œï¼‰
  email: z
    .string()
    .email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
    .min(1, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™')
    .max(255, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé•·ã™ãã¾ã™')
    .transform(email => email.toLowerCase().trim()),

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¼·åŠ›ãªè¦ä»¶ï¼‰
  password: z
    .string()
    .min(12, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯12æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™')
    .max(128, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•·ã™ãã¾ã™')
    .regex(
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,
      'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™'
    )
    .refine(
      password => !commonPasswords.includes(password.toLowerCase()),
      'ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“'
    ),

  // åå‰ï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰
  name: z
    .string()
    .min(1, 'åå‰ã¯å¿…é ˆã§ã™')
    .max(100, 'åå‰ãŒé•·ã™ãã¾ã™')
    .regex(
      /^[a-zA-Zã‚-ã‚“ ã‚¡-ãƒ´ãƒ¼ä¸€-é¾¯\u3400-\u4DBF\u4E00-\u9FFF\s\-'\.]+$/,
      'åå‰ã«ç„¡åŠ¹ãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™'
    )
    .transform(name => sanitizeInput(name)),

  // UUID
  uuid: z
    .string()
    .uuid('ç„¡åŠ¹ãªIDå½¢å¼ã§ã™'),

  // URL
  url: z
    .string()
    .url('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
    .refine(url => url.startsWith('https://'), 'HTTPSã®URLã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™'),

  // JSONï¼ˆå®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
  safeJson: z
    .string()
    .refine(
      str => {
        try {
          const parsed = JSON.parse(str);
          return typeof parsed === 'object' && parsed !== null;
        } catch {
          return false;
        }
      },
      'æœ‰åŠ¹ãªJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“'
    )
    .transform(str => JSON.parse(str)),
};

// è¤‡åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
export const schemas = {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  register: z.object({
    email: commonRules.email,
    password: commonRules.password,
    confirmPassword: z.string().min(1, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã¯å¿…é ˆã§ã™'),
    firstName: commonRules.name,
    lastName: commonRules.name,
    agreeToTerms: z.boolean().refine(val => val === true, 'åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„'),
    agreeToPrivacy: z.boolean().refine(val => val === true, 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„'),
  }).refine(
    data => data.password === data.confirmPassword,
    {
      message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“',
      path: ['confirmPassword'],
    }
  ),

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
  updateProfile: z.object({
    firstName: commonRules.name.optional(),
    lastName: commonRules.name.optional(),
    bio: z
      .string()
      .max(500, 'è‡ªå·±ç´¹ä»‹ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„')
      .optional()
      .transform(bio => bio ? sanitizeInput(bio) : undefined),
    website: commonRules.url.optional(),
    avatar: z
      .instanceof(File)
      .refine(file => file.size <= 2 * 1024 * 1024, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™')
      .refine(
        file => ['image/jpeg', 'image/png', 'image/webp'].includes(file.type),
        'JPEGã€PNGã€WebPå½¢å¼ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™'
      )
      .optional(),
  }),

  // æ¤œç´¢ã‚¯ã‚¨ãƒª
  search: z.object({
    query: z
      .string()
      .min(1, 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™')
      .max(100, 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒé•·ã™ãã¾ã™')
      .transform(query => sanitizeInput(query)),
    filters: z
      .object({
        category: z.string().optional(),
        dateFrom: z.string().datetime().optional(),
        dateTo: z.string().datetime().optional(),
        limit: z.number().min(1).max(100).default(20),
        offset: z.number().min(0).default(0),
      })
      .optional(),
  }),
};

// é«˜åº¦ãªã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
export const sanitizeInput = (input: string): string => {
  // HTMLã‚¿ã‚°ã‚’å®‰å…¨ã«é™¤å»
  const cleaned = DOMPurify.sanitize(input, { 
    ALLOWED_TAGS: [],
    ALLOWED_ATTR: [],
  });
  
  return cleaned
    .trim()
    .replace(/\s+/g, ' ') // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’å˜ä¸€ç©ºç™½ã«
    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // åˆ¶å¾¡æ–‡å­—é™¤å»
    .substring(0, 1000); // æœ€å¤§é•·åˆ¶é™
};

// SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
export const detectSQLInjection = (input: string): boolean => {
  const sqlPatterns = [
    /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|DECLARE)\b)/i,
    /(\b(OR|AND)\s+(1=1|'1'='1'|"1"="1"))/i,
    /(--|\/\*|\*\/|;)/,
    /(\b(xp_|sp_|fn_)\w+)/i,
    /(INFORMATION_SCHEMA|SYSOBJECTS|SYSCOLUMNS)/i,
  ];

  return sqlPatterns.some(pattern => pattern.test(input));
};

// XSSæ¤œå‡º
export const detectXSS = (input: string): boolean => {
  const xssPatterns = [
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    /javascript:/gi,
    /on\w+\s*=/gi,
    /data:text\/html/gi,
    /<iframe\b[^>]*>/gi,
    /<object\b[^>]*>/gi,
    /<embed\b[^>]*>/gi,
  ];

  return xssPatterns.some(pattern => pattern.test(input));
};

// ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆä¸€éƒ¨ï¼‰
const commonPasswords = [
  'password', '123456', 'password123', 'admin', 'qwerty',
  'letmein', 'welcome', 'monkey', '1234567890', 'password1'
];
```

## èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

### 1. èªè¨¼ãƒ•ãƒƒã‚¯
```typescript
// src/hooks/auth/useAuth.ts
import { useContext } from 'react';
import { AuthContext } from '@/contexts/AuthContext';

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

// æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒƒã‚¯
export const usePermissions = () => {
  const { user } = useAuth();
  
  const hasPermission = (permission: string, resourceId?: string) => {
    // æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
    return checkUserPermission(user?.id, permission, resourceId);
  };
  
  const hasRole = (role: string) => {
    // ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
    return user?.app_metadata?.roles?.includes(role) ?? false;
  };
  
  return { hasPermission, hasRole };
};
```

### 2. ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ
```typescript
// src/components/common/ProtectedRoute.tsx
import React from 'react';
import { useAuth } from '@/hooks/auth/useAuth';

interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredPermission?: string;
  requiredRole?: string;
  fallback?: React.ReactNode;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({
  children,
  requiredPermission,
  requiredRole,
  fallback
}) => {
  const { user, loading } = useAuth();
  const { hasPermission, hasRole } = usePermissions();

  if (loading) {
    return <LoadingSpinner />;
  }

  if (!user) {
    return <LoginRequired />;
  }

  if (requiredPermission && !hasPermission(requiredPermission)) {
    return fallback || <AccessDenied />;
  }

  if (requiredRole && !hasRole(requiredRole)) {
    return fallback || <AccessDenied />;
  }

  return <>{children}</>;
};
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»CSP

### Content Security Policy
```typescript
// vercel.json ã¾ãŸã¯ Next.js config
const securityHeaders = [
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=31536000; includeSubDomains; preload'
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.stripe.com; frame-src https://js.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self';"
  }
];
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°
```typescript
// src/utils/security-logger.ts
interface SecurityEvent {
  type: 'auth_failure' | 'permission_denied' | 'suspicious_activity' | 'data_breach_attempt';
  userId?: string;
  ip?: string;
  userAgent?: string;
  details: Record<string, any>;
  timestamp: string;
}

export const logSecurityEvent = async (event: SecurityEvent) => {
  // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
  if (import.meta.env.PROD) {
    await sendToSecurityService(event);
  } else {
    console.warn('Security Event:', event);
  }
  
  // é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã¯å³åº§ã«ã‚¢ãƒ©ãƒ¼ãƒˆ
  if (event.type === 'data_breach_attempt') {
    await sendImmediateAlert(event);
  }
};
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### é–‹ç™ºæ™‚ãƒã‚§ãƒƒã‚¯é …ç›®
- [ ] ç’°å¢ƒå¤‰æ•°ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ±ãŒãªã„ã‹
- [ ] å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ãŒé©åˆ‡ã‹
- [ ] XSSå¯¾ç­–ãŒé©åˆ‡ã‹
- [ ] CSRFå¯¾ç­–ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] èªè¨¼ãƒ»èªå¯ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] RLSãƒãƒªã‚·ãƒ¼ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§æƒ…å ±æ¼æ´©ãŒãªã„ã‹
- [ ] ãƒ­ã‚°å‡ºåŠ›ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®åˆ¶é™ãŒé©åˆ‡ã‹
- [ ] APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒé©åˆ‡ã‹
- [ ] æš—å·åŒ–ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
